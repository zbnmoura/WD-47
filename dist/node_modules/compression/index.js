"use strict";var accepts=require("accepts"),Buffer=require("safe-buffer").Buffer,bytes=require("bytes"),compressible=require("compressible"),debug=require("debug")("compression"),onHeaders=require("on-headers"),vary=require("vary"),zlib=require("zlib");module.exports=compression,module.exports.filter=shouldCompress;var cacheControlNoTransformRegExp=/(?:^|,)\s*?no-transform\s*?(?:,|$)/;function compression(e){var n=e||{},r=n.filter||shouldCompress,t=bytes.parse(n.threshold);return null==t&&(t=1024),function(e,i,o){var s,a,u=!1,d=[],c=i.end,l=i.on,f=i.write;function h(e){debug("no compression: %s",e),addListeners(i,l,d),d=null}i.flush=function(){a&&a.flush()},i.write=function(e,n){return!u&&(this._header||this._implicitHeader(),a?a.write(Buffer.from(e,n)):f.call(this,e,n))},i.end=function(e,n){return!u&&(this._header||(this.getHeader("Content-Length")||(s=chunkLength(e,n)),this._implicitHeader()),a?(u=!0,e?a.end(Buffer.from(e,n)):a.end()):c.call(this,e,n))},i.on=function(e,n){return d&&"drain"===e?a?a.on(e,n):(d.push([e,n]),this):l.call(this,e,n)},onHeaders(i,function(){if(r(e,i))if(shouldTransform(e,i))if(vary(i,"Accept-Encoding"),Number(i.getHeader("Content-Length"))<t||s<t)h("size below threshold");else if("identity"===(i.getHeader("Content-Encoding")||"identity"))if("HEAD"!==e.method){var o=accepts(e),u=o.encoding(["gzip","deflate","identity"]);"deflate"===u&&o.encoding(["gzip"])&&(u=o.encoding(["gzip","identity"])),u&&"identity"!==u?(debug("%s compression",u),addListeners(a="gzip"===u?zlib.createGzip(n):zlib.createDeflate(n),a.on,d),i.setHeader("Content-Encoding",u),i.removeHeader("Content-Length"),a.on("data",function(e){!1===f.call(i,e)&&a.pause()}),a.on("end",function(){c.call(i)}),l.call(i,"drain",function(){a.resume()})):h("not acceptable")}else h("HEAD request");else h("already encoded");else h("no transform");else h("filtered")}),o()}}function addListeners(e,n,r){for(var t=0;t<r.length;t++)n.apply(e,r[t])}function chunkLength(e,n){return e?Buffer.isBuffer(e)?e.length:Buffer.byteLength(e,n):0}function shouldCompress(e,n){var r=n.getHeader("Content-Type");return!(void 0===r||!compressible(r))||(debug("%s not compressible",r),!1)}function shouldTransform(e,n){var r=n.getHeader("Cache-Control");return!r||!cacheControlNoTransformRegExp.test(r)}