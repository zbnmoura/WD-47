"use strict";var accepts=require("accepts"),escapeHtml=require("escape-html"),fs=require("fs"),path=require("path"),util=require("util"),DOUBLE_SPACE_REGEXP=/\x20{2}/g,NEW_LINE_REGEXP=/\n/g,STYLESHEET=fs.readFileSync(path.join(__dirname,"/public/style.css"),"utf8"),TEMPLATE=fs.readFileSync(path.join(__dirname,"/public/error.html"),"utf8"),inspect=util.inspect,toString=Object.prototype.toString,defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};function escapeHtmlBlock(e){return escapeHtml(e).replace(DOUBLE_SPACE_REGEXP," &nbsp;").replace(NEW_LINE_REGEXP,"<br>")}function stringify(e){var t=e.stack;if(t)return String(t);var r=String(e);return r===toString.call(e)?inspect(e):r}function logerror(e,t){console.error(t||e.stack)}exports=module.exports=function(e){var t=process.env.NODE_ENV||"development",r=e||{},s=void 0===r.log?"test"!==t:r.log;if("function"!=typeof s&&"boolean"!=typeof s)throw new TypeError("option log must be function or boolean");return!0===s&&(s=logerror),function(e,t,r,n){e.statusCode&&(r.statusCode=e.statusCode),e.status&&(r.statusCode=e.status),r.statusCode<400&&(r.statusCode=500);var o=stringify(e);if(s&&defer(s,e,o,t,r),r._header)return t.socket.destroy();var a=accepts(t).type("html","json","text");if(r.setHeader("X-Content-Type-Options","nosniff"),"html"===a){var i=!e.stack&&String(e)===toString.call(e),c=i?"Error":escapeHtmlBlock(o.split("\n",1)[0]||"Error"),l=(i?[o]:String(o).split("\n").slice(1)).map(function(e){return"<li>"+escapeHtmlBlock(e)+"</li>"}).join(""),p=TEMPLATE.replace("{style}",STYLESHEET).replace("{stack}",l).replace("{title}",escapeHtml(exports.title)).replace("{statusCode}",r.statusCode).replace(/\{error\}/g,c);r.setHeader("Content-Type","text/html; charset=utf-8"),r.end(p)}else if("json"===a){var u={message:e.message,stack:e.stack};for(var f in e)u[f]=e[f];var E=JSON.stringify({error:u},null,2);r.setHeader("Content-Type","application/json; charset=utf-8"),r.end(E)}else r.setHeader("Content-Type","text/plain; charset=utf-8"),r.end(o)}},exports.title="Connect";