"use strict";var fs=require("fs"),polyfills=require("./polyfills.js"),legacy=require("./legacy-streams.js"),queue=[],util=require("util");function noop(){}var debug=noop;function patch(e){polyfills(e),e.gracefulify=patch,e.FileReadStream=f,e.FileWriteStream=a,e.createReadStream=function(e,t){return new f(e,t)},e.createWriteStream=function(e,t){return new a(e,t)};var t=e.readFile;e.readFile=function(e,n,r){"function"==typeof n&&(r=n,n=null);return function e(n,r,o){return t(n,r,function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?("function"==typeof o&&o.apply(this,arguments),retry()):enqueue([e,[n,r,o]])})}(e,n,r)};var n=e.writeFile;e.writeFile=function(e,t,r,o){"function"==typeof r&&(o=r,r=null);return function e(t,r,o,u){return n(t,r,o,function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?("function"==typeof u&&u.apply(this,arguments),retry()):enqueue([e,[t,r,o,u]])})}(e,t,r,o)};var r=e.appendFile;r&&(e.appendFile=function(e,t,n,o){"function"==typeof n&&(o=n,n=null);return function e(t,n,o,u){return r(t,n,o,function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?("function"==typeof u&&u.apply(this,arguments),retry()):enqueue([e,[t,n,o,u]])})}(e,t,n,o)});var o=e.readdir;function u(t){return o.apply(e,t)}if(e.readdir=function(e,t,n){var r=[e];"function"!=typeof t?r.push(t):n=t;return r.push(function(e,t){t&&t.sort&&t.sort(),!e||"EMFILE"!==e.code&&"ENFILE"!==e.code?("function"==typeof n&&n.apply(this,arguments),retry()):enqueue([u,[r]])}),u(r)},"v0.8"===process.version.substr(0,4)){var i=legacy(e);f=i.ReadStream,a=i.WriteStream}var c=e.ReadStream;f.prototype=Object.create(c.prototype),f.prototype.open=function(){var e=this;l(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())})};var p=e.WriteStream;function f(e,t){return this instanceof f?(c.apply(this,arguments),this):f.apply(Object.create(f.prototype),arguments)}function a(e,t){return this instanceof a?(p.apply(this,arguments),this):a.apply(Object.create(a.prototype),arguments)}a.prototype=Object.create(p.prototype),a.prototype.open=function(){var e=this;l(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))})},e.ReadStream=f,e.WriteStream=a;var s=e.open;function l(e,t,n,r){return"function"==typeof n&&(r=n,n=null),function e(t,n,r,o){return s(t,n,r,function(u,i){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?("function"==typeof o&&o.apply(this,arguments),retry()):enqueue([e,[t,n,r,o]])})}(e,t,n,r)}return e.open=l,e}function enqueue(e){debug("ENQUEUE",e[0].name,e[1]),queue.push(e)}function retry(){var e=queue.shift();e&&(debug("RETRY",e[0].name,e[1]),e[0].apply(null,e[1]))}util.debuglog?debug=util.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(debug=function(){var e=util.format.apply(util,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){debug(queue),require("assert").equal(queue.length,0)}),module.exports=patch(require("./fs.js")),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&(module.exports=patch(fs)),module.exports.close=fs.close=function(e){return function(t,n){return e.call(fs,t,function(e){e||retry(),"function"==typeof n&&n.apply(this,arguments)})}}(fs.close),module.exports.closeSync=fs.closeSync=function(e){return function(t){var n=e.apply(fs,arguments);return retry(),n}}(fs.closeSync);