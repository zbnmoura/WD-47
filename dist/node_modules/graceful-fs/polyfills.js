"use strict";var fs=require("./fs.js"),constants=require("constants"),origCwd=process.cwd,cwd=null,platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return cwd||(cwd=origCwd.call(process)),cwd};try{process.cwd()}catch(c){}var chdir=process.chdir;function patch(c){var n,t,o;constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&patchLchmod(c),c.lutimes||patchLutimes(c),c.chown=chownFix(c.chown),c.fchown=chownFix(c.fchown),c.lchown=chownFix(c.lchown),c.chmod=chmodFix(c.chmod),c.fchmod=chmodFix(c.fchmod),c.lchmod=chmodFix(c.lchmod),c.chownSync=chownFixSync(c.chownSync),c.fchownSync=chownFixSync(c.fchownSync),c.lchownSync=chownFixSync(c.lchownSync),c.chmodSync=chmodFixSync(c.chmodSync),c.fchmodSync=chmodFixSync(c.fchmodSync),c.lchmodSync=chmodFixSync(c.lchmodSync),c.stat=statFix(c.stat),c.fstat=statFix(c.fstat),c.lstat=statFix(c.lstat),c.statSync=statFixSync(c.statSync),c.fstatSync=statFixSync(c.fstatSync),c.lstatSync=statFixSync(c.lstatSync),c.lchmod||(c.lchmod=function(c,n,t){t&&process.nextTick(t)},c.lchmodSync=function(){}),c.lchown||(c.lchown=function(c,n,t,o){o&&process.nextTick(o)},c.lchownSync=function(){}),"win32"===platform&&(c.rename=(n=c.rename,function(t,o,i){var r=Date.now(),s=0;n(t,o,function e(u){if(u&&("EACCES"===u.code||"EPERM"===u.code)&&Date.now()-r<6e4)return setTimeout(function(){c.stat(o,function(c,r){c&&"ENOENT"===c.code?n(t,o,e):i(u)})},s),void(s<100&&(s+=10));i&&i(u)})})),c.read=(t=c.read,function(n,o,i,r,s,e){var u;if(e&&"function"==typeof e){var a=0;u=function(f,h,l){if(f&&"EAGAIN"===f.code&&a<10)return a++,t.call(c,n,o,i,r,s,u);e.apply(this,arguments)}}return t.call(c,n,o,i,r,s,u)}),c.readSync=(o=c.readSync,function(n,t,i,r,s){for(var e=0;;)try{return o.call(c,n,t,i,r,s)}catch(c){if("EAGAIN"===c.code&&e<10){e++;continue}throw c}})}function patchLchmod(c){c.lchmod=function(n,t,o){c.open(n,constants.O_WRONLY|constants.O_SYMLINK,t,function(n,i){n?o&&o(n):c.fchmod(i,t,function(n){c.close(i,function(c){o&&o(n||c)})})})},c.lchmodSync=function(n,t){var o,i=c.openSync(n,constants.O_WRONLY|constants.O_SYMLINK,t),r=!0;try{o=c.fchmodSync(i,t),r=!1}finally{if(r)try{c.closeSync(i)}catch(c){}else c.closeSync(i)}return o}}function patchLutimes(c){constants.hasOwnProperty("O_SYMLINK")?(c.lutimes=function(n,t,o,i){c.open(n,constants.O_SYMLINK,function(n,r){n?i&&i(n):c.futimes(r,t,o,function(n){c.close(r,function(c){i&&i(n||c)})})})},c.lutimesSync=function(n,t,o){var i,r=c.openSync(n,constants.O_SYMLINK),s=!0;try{i=c.futimesSync(r,t,o),s=!1}finally{if(s)try{c.closeSync(r)}catch(c){}else c.closeSync(r)}return i}):(c.lutimes=function(c,n,t,o){o&&process.nextTick(o)},c.lutimesSync=function(){})}function chmodFix(c){return c?function(n,t,o){return c.call(fs,n,t,function(c){chownErOk(c)&&(c=null),o&&o.apply(this,arguments)})}:c}function chmodFixSync(c){return c?function(n,t){try{return c.call(fs,n,t)}catch(c){if(!chownErOk(c))throw c}}:c}function chownFix(c){return c?function(n,t,o,i){return c.call(fs,n,t,o,function(c){chownErOk(c)&&(c=null),i&&i.apply(this,arguments)})}:c}function chownFixSync(c){return c?function(n,t,o){try{return c.call(fs,n,t,o)}catch(c){if(!chownErOk(c))throw c}}:c}function statFix(c){return c?function(n,t){return c.call(fs,n,function(c,n){if(!n)return t.apply(this,arguments);n.uid<0&&(n.uid+=4294967296),n.gid<0&&(n.gid+=4294967296),t&&t.apply(this,arguments)})}:c}function statFixSync(c){return c?function(n){var t=c.call(fs,n);return t.uid<0&&(t.uid+=4294967296),t.gid<0&&(t.gid+=4294967296),t}:c}function chownErOk(c){return!c||("ENOSYS"===c.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==c.code&&"EPERM"!==c.code))}process.chdir=function(c){cwd=null,chdir.call(process,c)},module.exports=patch;