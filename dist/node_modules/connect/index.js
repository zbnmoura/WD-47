"use strict";var debug=require("debug")("connect:dispatcher"),EventEmitter=require("events").EventEmitter,finalhandler=require("finalhandler"),http=require("http"),merge=require("utils-merge"),parseUrl=require("parseurl");module.exports=createServer;var env=process.env.NODE_ENV||"development",proto={},defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};function createServer(){function e(r,t,n){e.handle(r,t,n)}return merge(e,proto),merge(e,EventEmitter.prototype),e.route="/",e.stack=[],e}function call(e,r,t,n,o,i){var u=e.length,l=t,s=Boolean(t);debug("%s %s : %s",e.name||"<anonymous>",r,n.originalUrl);try{if(s&&4===u)return void e(t,n,o,i);if(!s&&u<4)return void e(n,o,i)}catch(e){l=e}i(l)}function logerror(e){"test"!==env&&console.error(e.stack||e.toString())}function getProtohost(e){if(0!==e.length&&"/"!==e[0]){var r=e.indexOf("?"),t=-1!==r?r:e.length,n=e.substr(0,t).indexOf("://");return-1!==n?e.substr(0,e.indexOf("/",3+n)):void 0}}proto.use=function(e,r){var t=r,n=e;if("string"!=typeof e&&(t=e,n="/"),"function"==typeof t.handle){var o=t;o.route=n,t=function(e,r,t){o.handle(e,r,t)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"===n[n.length-1]&&(n=n.slice(0,-1)),debug("use %s %s",n||"/",t.name||"anonymous"),this.stack.push({route:n,handle:t}),this},proto.handle=function(e,r,t){var n=0,o=getProtohost(e.url)||"",i="",u=!1,l=this.stack,s=t||finalhandler(e,r,{env:env,onerror:logerror});e.originalUrl=e.originalUrl||e.url,function t(a){u&&(e.url=e.url.substr(1),u=!1),0!==i.length&&(e.url=o+i+e.url.substr(o.length),i="");var c=l[n++];if(c){var h=parseUrl(e).pathname||"/",f=c.route;if(h.toLowerCase().substr(0,f.length)!==f.toLowerCase())return t(a);var v=h[f.length];if(void 0!==v&&"/"!==v&&"."!==v)return t(a);0!==f.length&&"/"!==f&&(i=f,e.url=o+e.url.substr(o.length+i.length),o||"/"===e.url[0]||(e.url="/"+e.url,u=!0)),call(c.handle,f,a,e,r,t)}else defer(s,a)}()},proto.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};