"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},debug=require("debug")("finalhandler"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),onFinished=require("on-finished"),parseUrl=require("parseurl"),statuses=require("statuses"),unpipe=require("unpipe"),DOUBLE_SPACE_REGEXP=/\x20{2}/g,NEWLINE_REGEXP=/\n/g,defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))},isFinished=onFinished.isFinished;function createHtmlDocument(e){return'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>'+escapeHtml(e).replace(NEWLINE_REGEXP,"<br>").replace(DOUBLE_SPACE_REGEXP," &nbsp;")+"</pre>\n</body>\n</html>\n"}function finalhandler(e,t,r){var n=r||{},s=n.env||process.env.NODE_ENV||"development",o=n.onerror;return function(r){var n,a,u;if(r||!headersSent(t)){if(r?(void 0!==(u=getErrorStatusCode(r))&&(n=getErrorHeaders(r)),void 0===u&&(u=getResponseStatusCode(t)),a=getErrorMessage(r,u,s)):(u=404,a="Cannot "+e.method+" "+encodeUrl(parseUrl.original(e).pathname)),debug("default %s",u),r&&o&&defer(o,r,e,t),headersSent(t))return debug("cannot %d after headers sent",u),void e.socket.destroy();send(e,t,u,n,a)}else debug("cannot 404 after headers sent")}}function getErrorHeaders(e){if(e.headers&&"object"===_typeof(e.headers)){for(var t=Object.create(null),r=Object.keys(e.headers),n=0;n<r.length;n++){var s=r[n];t[s]=e.headers[s]}return t}}function getErrorMessage(e,t,r){var n;return"production"!==r&&((n=e.stack)||"function"!=typeof e.toString||(n=e.toString())),n||statuses[t]}function getErrorStatusCode(e){return"number"==typeof e.status&&e.status>=400&&e.status<600?e.status:"number"==typeof e.statusCode&&e.statusCode>=400&&e.statusCode<600?e.statusCode:void 0}function getResponseStatusCode(e){var t=e.statusCode;return("number"!=typeof t||t<400||t>599)&&(t=500),t}function headersSent(e){return"boolean"!=typeof e.headersSent?Boolean(e._header):e.headersSent}function send(e,t,r,n,s){function o(){var o=createHtmlDocument(s);t.statusCode=r,t.statusMessage=statuses[r],setHeaders(t,n),t.setHeader("Content-Security-Policy","default-src 'self'"),t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Content-Length",Buffer.byteLength(o,"utf8")),"HEAD"!==e.method?t.end(o,"utf8"):t.end()}isFinished(e)?o():(unpipe(e),onFinished(e,o),e.resume())}function setHeaders(e,t){if(t)for(var r=Object.keys(t),n=0;n<r.length;n++){var s=r[n];e.setHeader(s,t[s])}}module.exports=finalhandler;