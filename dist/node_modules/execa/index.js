"use strict";var childProcess=require("child_process"),util=require("util"),crossSpawn=require("cross-spawn"),stripEof=require("strip-eof"),npmRunPath=require("npm-run-path"),isStream=require("is-stream"),_getStream=require("get-stream"),pFinally=require("p-finally"),onExit=require("signal-exit"),errname=require("./lib/errname"),stdio=require("./lib/stdio"),TEN_MEGABYTES=1e7;function handleArgs(e,t,r){var n=void 0;return r&&r.env&&!1!==r.extendEnv&&(r.env=Object.assign({},process.env,r.env)),r&&!0===r.__winShell?(delete r.__winShell,n={command:e,args:t,options:r,file:e,original:e}):n=crossSpawn._parse(e,t,r),(r=Object.assign({maxBuffer:TEN_MEGABYTES,stripEof:!0,preferLocal:!0,localDir:n.options.cwd||process.cwd(),encoding:"utf8",reject:!0,cleanup:!0},n.options)).stdio=stdio(r),r.preferLocal&&(r.env=npmRunPath.env(Object.assign({},r,{cwd:r.localDir}))),{cmd:n.command,args:n.args,opts:r,parsed:n}}function handleInput(e,t){var r=t.input;null!==r&&void 0!==r&&(isStream(r)?r.pipe(e.stdin):e.stdin.end(r))}function handleOutput(e,t){return t&&e.stripEof&&(t=stripEof(t)),t}function handleShell(e,t,r){var n="/bin/sh",s=["-c",t];return r=Object.assign({},r),"win32"===process.platform&&(r.__winShell=!0,n=process.env.comspec||"cmd.exe",s=["/s","/c",'"'+t+'"'],r.windowsVerbatimArguments=!0),r.shell&&(n=r.shell,delete r.shell),e(n,s,r)}function getStream(e,t,r,n){if(!e[t])return null;return(r?_getStream(e[t],{encoding:r,maxBuffer:n}):_getStream.buffer(e[t],{maxBuffer:n})).catch(function(e){throw e.stream=t,e.message=t+" "+e.message,e})}module.exports=function(e,t,r){var n=e;Array.isArray(t)&&t.length>0&&(n+=" "+t.join(" "));var s=handleArgs(e,t,r),o=s.opts.encoding,i=s.opts.maxBuffer,l=void 0;try{l=childProcess.spawn(s.cmd,s.args,s.opts)}catch(e){return Promise.reject(e)}var u=void 0;s.opts.cleanup&&(u=onExit(function(){l.kill()}));var a=null,d=!1,c=function(){a&&(clearTimeout(a),a=null)};s.opts.timeout>0&&(a=setTimeout(function(){a=null,d=!0,l.kill(s.opts.killSignal)},s.opts.timeout));var p=new Promise(function(e){l.on("exit",function(t,r){c(),e({code:t,signal:r})}),l.on("error",function(t){c(),e({err:t})}),l.stdin&&l.stdin.on("error",function(t){c(),e({err:t})})});var m=pFinally(Promise.all([p,getStream(l,"stdout",o,i),getStream(l,"stderr",o,i)]).then(function(e){var t=e[0],r=e[1],o=e[2],i=t.err,a=t.code,c=t.signal;if(u&&u(),i||0!==a||null!==c){if(!i){var p="";Array.isArray(s.opts.stdio)?("inherit"!==s.opts.stdio[2]&&(p+=p.length>0?o:"\n"+o),"inherit"!==s.opts.stdio[1]&&(p+="\n"+r)):"inherit"!==s.opts.stdio&&(p="\n"+o+r),(i=new Error("Command failed: "+n+p)).code=a<0?errname(a):a}if(i.killed=i.killed||l.killed,i.stdout=r,i.stderr=o,i.failed=!0,i.signal=c||null,i.cmd=n,i.timedOut=d,!s.opts.reject)return i;throw i}return{stdout:handleOutput(s.opts,r),stderr:handleOutput(s.opts,o),code:0,failed:!1,killed:!1,signal:null,cmd:n,timedOut:!1}}),function(){l.stdout&&l.stdout.destroy(),l.stderr&&l.stderr.destroy()});return crossSpawn._enoent.hookChildProcess(l,s.parsed),handleInput(l,s.opts),l.then=m.then.bind(m),l.catch=m.catch.bind(m),l},module.exports.stdout=function(){return module.exports.apply(null,arguments).then(function(e){return e.stdout})},module.exports.stderr=function(){return module.exports.apply(null,arguments).then(function(e){return e.stderr})},module.exports.shell=function(e,t){return handleShell(module.exports,e,t)},module.exports.sync=function(e,t,r){var n=handleArgs(e,t,r);if(isStream(n.opts.input))throw new TypeError("The `input` option cannot be a stream in sync mode");var s=childProcess.spawnSync(n.cmd,n.args,n.opts);if(s.error||0!==s.status)throw s.error||new Error(""===s.stderr?s.stdout:s.stderr);return s.stdout=handleOutput(n.opts,s.stdout),s.stderr=handleOutput(n.opts,s.stderr),s},module.exports.shellSync=function(e,t){return handleShell(module.exports.sync,e,t)},module.exports.spawn=util.deprecate(module.exports,"execa.spawn() is deprecated. Use execa() instead.");