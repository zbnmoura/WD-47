"use strict";var EventEmitter=require("events").EventEmitter,fs=require("fs"),sysPath=require("path"),asyncEach=require("async-each"),anymatch=require("anymatch"),globParent=require("glob-parent"),isGlob=require("is-glob"),isAbsolute=require("path-is-absolute"),inherits=require("inherits"),NodeFsHandler=require("./lib/nodefs-handler"),FsEventsHandler=require("./lib/fsevents-handler"),arrify=function(t){return null==t?[]:Array.isArray(t)?t:[t]},flatten=function t(i,e){return null==e&&(e=[]),i.forEach(function(i){Array.isArray(i)?t(i,e):e.push(i)}),e},isString=function(t){return"string"==typeof t};function FSWatcher(t){EventEmitter.call(this);var i={};if(t)for(var e in t)i[e]=t[e];function s(t){return void 0===i[t]}this._watched=Object.create(null),this._closers=Object.create(null),this._ignoredPaths=Object.create(null),Object.defineProperty(this,"_globIgnored",{get:function(){return Object.keys(this._ignoredPaths)}}),this.closed=!1,this._throttled=Object.create(null),this._symlinkPaths=Object.create(null),s("persistent")&&(i.persistent=!0),s("ignoreInitial")&&(i.ignoreInitial=!1),s("ignorePermissionErrors")&&(i.ignorePermissionErrors=!1),s("interval")&&(i.interval=100),s("binaryInterval")&&(i.binaryInterval=300),s("disableGlobbing")&&(i.disableGlobbing=!1),this.enableBinaryInterval=i.binaryInterval!==i.interval,s("useFsEvents")&&(i.useFsEvents=!i.usePolling),FsEventsHandler.canUse()||(i.useFsEvents=!1),s("usePolling")&&!i.useFsEvents&&(i.usePolling="darwin"===process.platform);var n=process.env.CHOKIDAR_USEPOLLING;if(void 0!==n){var r=n.toLowerCase();i.usePolling="false"!==r&&"0"!==r&&("true"===r||"1"===r||!!r)}var o=process.env.CHOKIDAR_INTERVAL;o&&(i.interval=parseInt(o)),s("atomic")&&(i.atomic=!i.usePolling&&!i.useFsEvents),i.atomic&&(this._pendingUnlinks=Object.create(null)),s("followSymlinks")&&(i.followSymlinks=!0),s("awaitWriteFinish")&&(i.awaitWriteFinish=!1),!0===i.awaitWriteFinish&&(i.awaitWriteFinish={});var a=i.awaitWriteFinish;a&&(a.stabilityThreshold||(a.stabilityThreshold=2e3),a.pollInterval||(a.pollInterval=100),this._pendingWrites=Object.create(null)),i.ignored&&(i.ignored=arrify(i.ignored)),this._isntIgnored=function(t,i){return!this._isIgnored(t,i)}.bind(this);var h=0;this._emitReady=function(){++h>=this._readyCount&&(this._emitReady=Function.prototype,this._readyEmitted=!0,process.nextTick(this.emit.bind(this,"ready")))}.bind(this),this.options=i,Object.freeze(i)}inherits(FSWatcher,EventEmitter),FSWatcher.prototype._emit=function(t,i,e,s,n){this.options.cwd&&(i=sysPath.relative(this.options.cwd,i));var r=[t,i];void 0!==n?r.push(e,s,n):void 0!==s?r.push(e,s):void 0!==e&&r.push(e);var o=this.options.awaitWriteFinish;if(o&&this._pendingWrites[i])return this._pendingWrites[i].lastChange=new Date,this;if(this.options.atomic){if("unlink"===t)return this._pendingUnlinks[i]=r,setTimeout(function(){Object.keys(this._pendingUnlinks).forEach(function(t){this.emit.apply(this,this._pendingUnlinks[t]),this.emit.apply(this,["all"].concat(this._pendingUnlinks[t])),delete this._pendingUnlinks[t]}.bind(this))}.bind(this),"number"==typeof this.options.atomic?this.options.atomic:100),this;"add"===t&&this._pendingUnlinks[i]&&(t=r[0]="change",delete this._pendingUnlinks[i])}var a=function(){this.emit.apply(this,r),"error"!==t&&this.emit.apply(this,["all"].concat(r))}.bind(this);if(o&&("add"===t||"change"===t)&&this._readyEmitted){return this._awaitWriteFinish(i,o.stabilityThreshold,t,function(i,e){i?(t=r[0]="error",r[1]=i,a()):e&&(r.length>2?r[2]=e:r.push(e),a())}),this}if("change"===t&&!this._throttle("change",i,50))return this;if(!this.options.alwaysStat||void 0!==e||"add"!==t&&"addDir"!==t&&"change"!==t)a();else{var h=this.options.cwd?sysPath.join(this.options.cwd,i):i;fs.stat(h,function(t,i){!t&&i&&(r.push(i),a())})}return this},FSWatcher.prototype._handleError=function(t){var i=t&&t.code,e=this.options.ignorePermissionErrors;return t&&"ENOENT"!==i&&"ENOTDIR"!==i&&(!e||"EPERM"!==i&&"EACCES"!==i)&&this.emit("error",t),t||this.closed},FSWatcher.prototype._throttle=function(t,i,e){t in this._throttled||(this._throttled[t]=Object.create(null));var s=this._throttled[t];if(i in s)return!1;function n(){delete s[i],clearTimeout(r)}var r=setTimeout(n,e);return s[i]={timeoutObject:r,clear:n},s[i]},FSWatcher.prototype._awaitWriteFinish=function(t,i,e,s){var n,r=t;this.options.cwd&&!isAbsolute(t)&&(r=sysPath.join(this.options.cwd,t));var o=new Date,a=function(e){fs.stat(r,function(r,o){if(r)"ENOENT"!==r.code&&s(r);else{var h=new Date;e&&o.size!=e.size&&(this._pendingWrites[t].lastChange=h),h-this._pendingWrites[t].lastChange>=i?(delete this._pendingWrites[t],s(null,o)):n=setTimeout(a.bind(this,o),this.options.awaitWriteFinish.pollInterval)}}.bind(this))}.bind(this);t in this._pendingWrites||(this._pendingWrites[t]={lastChange:o,cancelWait:function(){return delete this._pendingWrites[t],clearTimeout(n),e}.bind(this)},n=setTimeout(a.bind(this),this.options.awaitWriteFinish.pollInterval))};var dotRe=/\..*\.(sw[px])$|\~$|\.subl.*\.tmp/;FSWatcher.prototype._isIgnored=function(t,i){if(this.options.atomic&&dotRe.test(t))return!0;if(!this._userIgnored){var e=this.options.cwd,s=this.options.ignored;e&&s&&(s=s.map(function(t){return"string"!=typeof t?t:isAbsolute(t)?t:sysPath.join(e,t)}));var n=arrify(s).filter(function(t){return"string"==typeof t&&!isGlob(t)}).map(function(t){return t+"/**"});this._userIgnored=anymatch(this._globIgnored.concat(s).concat(n))}return this._userIgnored([t,i])};var replacerRe=/^\.[\/\\]/;function importHandler(t){Object.keys(t.prototype).forEach(function(i){FSWatcher.prototype[i]=t.prototype[i]})}FSWatcher.prototype._getWatchHelpers=function(t,i){t=t.replace(replacerRe,"");var e,s=i||this.options.disableGlobbing||!isGlob(t)?t:globParent(t),n=sysPath.resolve(s),r=s!==t,o=!!r&&anymatch(t),a=this.options.followSymlinks,h=!(!r||!a)&&null,l=function(t){return null==h&&(h=t.fullParentDir!==n&&{realPath:t.fullParentDir,linkPath:n}),h?t.fullPath.replace(h.realPath,h.linkPath):t.fullPath},c=function(t){return sysPath.join(s,sysPath.relative(s,l(t)))},d=function(t){if(t.stat&&t.stat.isSymbolicLink())return f(t);var i=c(t);return(!r||o(i))&&this._isntIgnored(i,t.stat)&&(this.options.ignorePermissionErrors||this._hasReadPermissions(t.stat))}.bind(this),u=function(t){return!!r&&sysPath.relative(s,t).split(/[\/\\]/)},p=u(t);p&&p.length>1&&p.pop();var f=function(t){if(r){var i=u(l(t)),s=!1;e=!p.every(function(t,e){return"**"===t&&(s=!0),s||!i[e]||anymatch(t,i[e])})}return!e&&this._isntIgnored(c(t),t.stat)}.bind(this);return{followSymlinks:a,statMethod:a?"stat":"lstat",path:t,watchPath:s,entryPath:c,hasGlob:r,globFilter:o,filterPath:d,filterDir:f}},FSWatcher.prototype._getWatchedDir=function(t){var i=sysPath.resolve(t),e=this._remove.bind(this);return i in this._watched||(this._watched[i]={_items:Object.create(null),add:function(t){"."!==t&&".."!==t&&(this._items[t]=!0)},remove:function(t){delete this._items[t],this.children().length||fs.readdir(i,function(t){t&&e(sysPath.dirname(i),sysPath.basename(i))})},has:function(t){return t in this._items},children:function(){return Object.keys(this._items)}}),this._watched[i]},FSWatcher.prototype._hasReadPermissions=function(t){return Boolean(4&parseInt((511&(t&&t.mode)).toString(8)[0],10))},FSWatcher.prototype._remove=function(t,i){var e=sysPath.join(t,i),s=sysPath.resolve(e),n=this._watched[e]||this._watched[s];if(this._throttle("remove",e,100)){var r=Object.keys(this._watched);n||this.options.useFsEvents||1!==r.length||this.add(t,i,!0),this._getWatchedDir(e).children().forEach(function(t){this._remove(e,t)},this);var o=this._getWatchedDir(t),a=o.has(i);o.remove(i);var h=e;if(this.options.cwd&&(h=sysPath.relative(this.options.cwd,e)),this.options.awaitWriteFinish&&this._pendingWrites[h])if("add"===this._pendingWrites[h].cancelWait())return;delete this._watched[e],delete this._watched[s];var l=n?"unlinkDir":"unlink";a&&!this._isIgnored(e)&&this._emit(l,e),this.options.useFsEvents||this._closePath(e)}},FSWatcher.prototype._closePath=function(t){this._closers[t]&&(this._closers[t](),delete this._closers[t],this._getWatchedDir(sysPath.dirname(t)).remove(sysPath.basename(t)))},FSWatcher.prototype.add=function(t,i,e){var s=this.options.cwd;if(this.closed=!1,!(t=flatten(arrify(t))).every(isString))throw new TypeError("Non-string provided as watch path: "+t);return s&&(t=t.map(function(t){return isAbsolute(t)?t:"!"===t[0]?"!"+sysPath.join(s,t.substring(1)):sysPath.join(s,t)})),t=t.filter(function(t){if("!"!==t[0])return delete this._ignoredPaths[t],delete this._ignoredPaths[t+"/**"],this._userIgnored=null,!0;this._ignoredPaths[t.substring(1)]=!0},this),this.options.useFsEvents&&FsEventsHandler.canUse()?(this._readyCount||(this._readyCount=t.length),this.options.persistent&&(this._readyCount*=2),t.forEach(this._addToFsEvents,this)):(this._readyCount||(this._readyCount=0),this._readyCount+=t.length,asyncEach(t,function(t,s){this._addToNodeFs(t,!e,0,0,i,function(t,i){i&&this._emitReady(),s(t,i)}.bind(this))}.bind(this),function(t,e){e.forEach(function(t){t&&!this.closed&&this.add(sysPath.dirname(t),sysPath.basename(i||t))},this)}.bind(this))),this},FSWatcher.prototype.unwatch=function(t){return this.closed?this:((t=flatten(arrify(t))).forEach(function(t){isAbsolute(t)||this._closers[t]||(this.options.cwd&&(t=sysPath.join(this.options.cwd,t)),t=sysPath.resolve(t)),this._closePath(t),this._ignoredPaths[t]=!0,t in this._watched&&(this._ignoredPaths[t+"/**"]=!0),this._userIgnored=null},this),this)},FSWatcher.prototype.close=function(){return this.closed?this:(this.closed=!0,Object.keys(this._closers).forEach(function(t){this._closers[t](),delete this._closers[t]},this),this._watched=Object.create(null),this.removeAllListeners(),this)},FSWatcher.prototype.getWatched=function(){var t={};return Object.keys(this._watched).forEach(function(i){var e=this.options.cwd?sysPath.relative(this.options.cwd,i):i;t[e||"."]=Object.keys(this._watched[i]._items).sort()}.bind(this)),t},importHandler(NodeFsHandler),FsEventsHandler.canUse()&&importHandler(FsEventsHandler),exports.FSWatcher=FSWatcher,exports.watch=function(t,i){return new FSWatcher(i).add(t)};