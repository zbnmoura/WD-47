"use strict";var fs=require("fs"),util=require("util"),path=require("path"),EE=require("events").EventEmitter,extend=require("extend"),resolve=require("resolve"),flaggedRespawn=require("flagged-respawn"),isPlainObject=require("is-plain-object"),mapValues=require("object.map"),fined=require("fined"),findCwd=require("./lib/find_cwd"),findConfig=require("./lib/find_config"),fileSearch=require("./lib/file_search"),parseOptions=require("./lib/parse_options"),silentRequire=require("./lib/silent_require"),buildConfigName=require("./lib/build_config_name"),registerLoader=require("./lib/register_loader"),getNodeFlags=require("./lib/get_node_flags");function Liftoff(e){EE.call(this),extend(this,parseOptions(e))}util.inherits(Liftoff,EE),Liftoff.prototype.requireLocal=function(e,i){try{var r=require(resolve.sync(e,{basedir:i}));return this.emit("require",e,r),r}catch(i){this.emit("requireFail",e,i)}},Liftoff.prototype.buildEnvironment=function(e){var i=(e=e||{}).require||[];Array.isArray(i)||(i=[i]);var r=this.searchPaths.slice(),t=findCwd(e);e.cwd?r=[t]:r.unshift(t);var n,s,a,o=buildConfigName({configName:this.configName,extensions:Object.keys(this.extensions)}),f=findConfig({configNameSearch:o,searchPaths:r,configPath:e.configPath});f&&(n=path.dirname(f),e.cwd||(t=n),fs.lstatSync(f).isSymbolicLink()&&(f=fs.realpathSync(f)));try{var l=path.delimiter,c=process.env.NODE_PATH?process.env.NODE_PATH.split(l):[];s=resolve.sync(this.moduleName,{basedir:n||t,paths:c}),a=silentRequire(fileSearch("package.json",[s]))}catch(e){}if(!s&&f){var u=fileSearch("package.json",[n]);(a=silentRequire(u))&&a.name===this.moduleName?(s=path.join(path.dirname(u),a.main||"index.js"),t=n):a={}}i.length&&i.filter(function(e,i,r){return r.indexOf(e)===i}).forEach(function(i){this.requireLocal(i,findCwd(e))},this);var h=this.extensions,d=this;registerLoader(d,h,f,t);var p={};if(isPlainObject(this.configFiles)){var g={path:null};p=mapValues(this.configFiles,function(e,i){var r={name:i,cwd:t,extensions:h};return mapValues(e,function(e){var i=fined(e,r)||g;return isPlainObject(i.extension)&&registerLoader(d,i.extension,i.path,t),i.path})})}return{cwd:t,require:i,configNameSearch:o,configPath:f,configBase:n,modulePath:s,modulePackage:a||{},configFiles:p}},Liftoff.prototype.handleFlags=function(e){"function"==typeof this.v8flags?this.v8flags(function(i,r){i?e(i):e(null,r)}):process.nextTick(function(){e(null,this.v8flags)}.bind(this))},Liftoff.prototype.launch=function(e,i){if("function"!=typeof i)throw new Error("You must provide a callback function.");process.title=this.processTitle;var r=e.completion;if(r&&this.completions)return this.completions(r);this.handleFlags(function(r,t){if(r)throw r;t=t||[];var n=this.buildEnvironment(e),s=getNodeFlags.arrayOrFunction(e.forcedFlags,n);flaggedRespawn(t,process.argv,s,function(e,r,t){if(r!==process){var s=getNodeFlags.fromReorderedArgv(t);this.emit("respawn",s,r)}e&&i.call(this,n,t)}.bind(this))}.bind(this))},module.exports=Liftoff;