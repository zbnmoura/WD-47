"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},EventEmitter=require("events"),http=require("http"),https=require("https"),PassThrough=require("stream").PassThrough,urlLib=require("url"),querystring=require("querystring"),duplexer3=require("duplexer3"),isStream=require("is-stream"),getStream=require("get-stream"),timedOut=require("timed-out"),urlParseLax=require("url-parse-lax"),lowercaseKeys=require("lowercase-keys"),isRedirect=require("is-redirect"),unzipResponse=require("unzip-response"),createErrorClass=require("create-error-class"),isRetryAllowed=require("is-retry-allowed"),Buffer=require("safe-buffer").Buffer,pkg=require("./package");function requestAsEventEmitter(e){e=e||{};var r=new EventEmitter,t=e.href||urlLib.resolve(urlLib.format(e),e.path),o=0,s=0,i=void 0;return function e(n){var a=("https:"===n.protocol?https:http).request(n,function(s){var u=s.statusCode;if(isRedirect(u)&&n.followRedirect&&"location"in s.headers&&("GET"===n.method||"HEAD"===n.method)){if(s.resume(),++o>10)return void r.emit("error",new got.MaxRedirectsError(u,n),null,s);var d=Buffer.from(s.headers.location,"binary").toString();i=urlLib.resolve(urlLib.format(n),d);var c=Object.assign({},n,urlLib.parse(i));return r.emit("redirect",s,c),void e(c)}setImmediate(function(){var e="function"==typeof unzipResponse&&"HEAD"!==a.method?unzipResponse(s):s;e.url=i||t,e.requestUrl=t,r.emit("response",e)})});a.once("error",function(t){var o=n.retries(++s,t);o?setTimeout(e,o,n):r.emit("error",new got.RequestError(t,n))}),n.gotTimeout&&timedOut(a,n.gotTimeout),setImmediate(function(){r.emit("request",a)})}(e),r}function asPromise(e){return new Promise(function(r,t){var o=requestAsEventEmitter(e);o.on("request",function(r){if(isStream(e.body))return e.body.pipe(r),void(e.body=void 0);r.end(e.body)}),o.on("response",function(o){(null===e.encoding?getStream.buffer(o):getStream(o,e)).catch(function(r){return t(new got.ReadError(r,e))}).then(function(t){var s=o.statusCode,i=e.followRedirect?299:399;if(o.body=t,e.json&&o.body)try{o.body=JSON.parse(o.body)}catch(r){throw new got.ParseError(r,s,e,t)}if(s<200||s>i)throw new got.HTTPError(s,e);r(o)}).catch(function(e){Object.defineProperty(e,"response",{value:o}),t(e)})}),o.on("error",t)})}function asStream(e){var r=new PassThrough,t=new PassThrough,o=duplexer3(r,t);if(e.json)throw new Error("got can not be used as stream when options.json is used");e.body&&(o.write=function(){throw new Error("got's stream is not writable when options.body is used")});var s=requestAsEventEmitter(e);return s.on("request",function(t){o.emit("request",t),isStream(e.body)?e.body.pipe(t):e.body?t.end(e.body):"POST"!==e.method&&"PUT"!==e.method&&"PATCH"!==e.method?t.end():r.pipe(t)}),s.on("response",function(r){var s=r.statusCode;r.pipe(t),s<200||s>299?o.emit("error",new got.HTTPError(s,e),null,r):o.emit("response",r)}),s.on("redirect",o.emit.bind(o,"redirect")),s.on("error",o.emit.bind(o,"error")),o}function normalizeArguments(e,r){if("string"!=typeof e&&"object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("Parameter `url` must be a string or object, not "+(void 0===e?"undefined":_typeof(e)));if("string"==typeof e&&(e=e.replace(/^unix:/,"http://$&"),(e=urlParseLax(e)).auth))throw new Error("Basic authentication must be done with auth option");(r=Object.assign({protocol:"http:",path:"",retries:5},e,r)).headers=Object.assign({"user-agent":pkg.name+"/"+pkg.version+" (https://github.com/sindresorhus/got)","accept-encoding":"gzip,deflate"},lowercaseKeys(r.headers));var t=r.query;t&&("string"!=typeof t&&(r.query=querystring.stringify(t)),r.path=r.path.split("?")[0]+"?"+r.query,delete r.query),r.json&&void 0===r.headers.accept&&(r.headers.accept="application/json");var o=r.body;if(o){if("string"!=typeof o&&(null===o||"object"!==(void 0===o?"undefined":_typeof(o))))throw new Error("options.body must be a ReadableStream, string, Buffer or plain Object");if(r.method=r.method||"POST",isStream(o)&&"function"==typeof o.getBoundary?r.headers["content-type"]=r.headers["content-type"]||"multipart/form-data; boundary="+o.getBoundary():null===o||"object"!==(void 0===o?"undefined":_typeof(o))||Buffer.isBuffer(o)||isStream(o)||(r.headers["content-type"]=r.headers["content-type"]||"application/x-www-form-urlencoded",o=r.body=querystring.stringify(o)),void 0===r.headers["content-length"]&&void 0===r.headers["transfer-encoding"]&&!isStream(o)){var s="string"==typeof o?Buffer.byteLength(o):o.length;r.headers["content-length"]=s}}if(r.method=(r.method||"GET").toUpperCase(),"unix"===r.hostname){var i=/(.+):(.+)/.exec(r.path);i&&(r.socketPath=i[1],r.path=i[2],r.host=null)}if("function"!=typeof r.retries){var n=r.retries;r.retries=function(e,r){return e>n||!isRetryAllowed(r)?0:1e3*(1<<e)+100*Math.random()}}return void 0===r.followRedirect&&(r.followRedirect=!0),r.timeout&&(r.gotTimeout=r.timeout,delete r.timeout),r}function got(e,r){try{return asPromise(normalizeArguments(e,r))}catch(e){return Promise.reject(e)}}var helpers=["get","post","put","patch","head","delete"];helpers.forEach(function(e){got[e]=function(r,t){return got(r,Object.assign({},t,{method:e}))}}),got.stream=function(e,r){return asStream(normalizeArguments(e,r))};var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var e=_step.value;got.stream[e]=function(r,t){return got.stream(r,Object.assign({},t,{method:e}))}},_iterator=helpers[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(e){_didIteratorError=!0,_iteratorError=e}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}function stdError(e,r){void 0!==e.code&&(this.code=e.code),Object.assign(this,{message:e.message,host:r.host,hostname:r.hostname,method:r.method,path:r.path})}got.RequestError=createErrorClass("RequestError",stdError),got.ReadError=createErrorClass("ReadError",stdError),got.ParseError=createErrorClass("ParseError",function(e,r,t,o){stdError.call(this,e,t),this.statusCode=r,this.statusMessage=http.STATUS_CODES[this.statusCode],this.message=e.message+' in "'+urlLib.format(t)+'": \n'+o.slice(0,77)+"..."}),got.HTTPError=createErrorClass("HTTPError",function(e,r){stdError.call(this,{},r),this.statusCode=e,this.statusMessage=http.STATUS_CODES[this.statusCode],this.message="Response code "+this.statusCode+" ("+this.statusMessage+")"}),got.MaxRedirectsError=createErrorClass("MaxRedirectsError",function(e,r){stdError.call(this,{},r),this.statusCode=e,this.statusMessage=http.STATUS_CODES[this.statusCode],this.message="Redirected 10 times. Aborting."}),module.exports=got;