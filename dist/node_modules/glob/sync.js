"use strict";module.exports=globSync,globSync.GlobSync=GlobSync;var fs=require("fs"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,Glob=require("./glob.js").Glob,util=require("util"),path=require("path"),assert=require("assert"),common=require("./common.js"),alphasort=common.alphasort,alphasorti=common.alphasorti,isAbsolute=common.isAbsolute,setopts=common.setopts,ownProp=common.ownProp,childrenIgnored=common.childrenIgnored;function globSync(t,r){if("function"==typeof r||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");return new GlobSync(t,r).found}function GlobSync(t,r){if(!t)throw new Error("must provide pattern");if("function"==typeof r||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");if(!(this instanceof GlobSync))return new GlobSync(t,r);if(setopts(this,t,r),this.noprocess)return this;var s=this.minimatch.set.length;this.matches=new Array(s);for(var i=0;i<s;i++)this._process(this.minimatch.set[i],i,!1);this._finish()}GlobSync.prototype._finish=function(){if(assert(this instanceof GlobSync),this.realpath){var t=this;this.matches.forEach(function(r,s){var i=t.matches[s]=Object.create(null);for(var e in r)try{e=t._makeAbs(e);var o=fs.realpathSync(e,this.realpathCache);i[o]=!0}catch(r){if("stat"!==r.syscall)throw r;i[t._makeAbs(e)]=!0}})}common.finish(this)},GlobSync.prototype._process=function(t,r,s){assert(this instanceof GlobSync);for(var i,e=0;"string"==typeof t[e];)e++;switch(e){case t.length:return void this._processSimple(t.join("/"),r);case 0:i=null;break;default:i=t.slice(0,e).join("/")}var o,a=t.slice(e);null===i?o=".":isAbsolute(i)||isAbsolute(t.join("/"))?(i&&isAbsolute(i)||(i="/"+i),o=i):o=i;var c=this._makeAbs(o);childrenIgnored(this,o)||(a[0]===minimatch.GLOBSTAR?this._processGlobStar(i,o,c,a,r,s):this._processReaddir(i,o,c,a,r,s))},GlobSync.prototype._processReaddir=function(t,r,s,i,e,o){var a=this._readdir(s,o);if(a){for(var c=i[0],n=!!this.minimatch.negate,h=c._glob,l=this.dot||"."===h.charAt(0),m=[],f=0;f<a.length;f++){if("."!==(y=a[f]).charAt(0)||l)(n&&!t?!y.match(c):y.match(c))&&m.push(y)}var p=m.length;if(0!==p)if(1!==i.length||this.mark||this.stat){i.shift();for(f=0;f<p;f++){var u;y=m[f];u=t?[t,y]:[y],this._process(u.concat(i),e,o)}}else{this.matches[e]||(this.matches[e]=Object.create(null));for(var f=0;f<p;f++){var y=m[f];t&&(y="/"!==t.slice(-1)?t+"/"+y:t+y),"/"!==y.charAt(0)||this.nomount||(y=path.join(this.root,y)),this.matches[e][y]=!0}}}},GlobSync.prototype._emitMatch=function(t,r){this._makeAbs(r);if(this.mark&&(r=this._mark(r)),!this.matches[t][r]){if(this.nodir){var s=this.cache[this._makeAbs(r)];if("DIR"===s||Array.isArray(s))return}this.matches[t][r]=!0,this.stat&&this._stat(r)}},GlobSync.prototype._readdirInGlobStar=function(t){if(this.follow)return this._readdir(t,!1);var r,s;try{s=fs.lstatSync(t)}catch(t){return null}var i=s.isSymbolicLink();return this.symlinks[t]=i,i||s.isDirectory()?r=this._readdir(t,!1):this.cache[t]="FILE",r},GlobSync.prototype._readdir=function(t,r){if(r&&!ownProp(this.symlinks,t))return this._readdirInGlobStar(t);if(ownProp(this.cache,t)){var s=this.cache[t];if(!s||"FILE"===s)return null;if(Array.isArray(s))return s}try{return this._readdirEntries(t,fs.readdirSync(t))}catch(r){return this._readdirError(t,r),null}},GlobSync.prototype._readdirEntries=function(t,r){if(!this.mark&&!this.stat)for(var s=0;s<r.length;s++){var i=r[s];i="/"===t?t+i:t+"/"+i,this.cache[i]=!0}return this.cache[t]=r,r},GlobSync.prototype._readdirError=function(t,r){switch(r.code){case"ENOTDIR":this.cache[this._makeAbs(t)]="FILE";break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(t)]=!1;break;default:if(this.cache[this._makeAbs(t)]=!1,this.strict)throw r;this.silent||console.error("glob error",r)}},GlobSync.prototype._processGlobStar=function(t,r,s,i,e,o){var a=this._readdir(s,o);if(a){var c=i.slice(1),n=t?[t]:[],h=n.concat(c);this._process(h,e,!1);var l=a.length;if(!this.symlinks[s]||!o)for(var m=0;m<l;m++){if("."!==a[m].charAt(0)||this.dot){var f=n.concat(a[m],c);this._process(f,e,!0);var p=n.concat(a[m],i);this._process(p,e,!0)}}}},GlobSync.prototype._processSimple=function(t,r){var s=this._stat(t);if(this.matches[r]||(this.matches[r]=Object.create(null)),s){if(t&&isAbsolute(t)&&!this.nomount){var i=/[\/\\]$/.test(t);"/"===t.charAt(0)?t=path.join(this.root,t):(t=path.resolve(this.root,t),i&&(t+="/"))}"win32"===process.platform&&(t=t.replace(/\\/g,"/")),this.matches[r][t]=!0}},GlobSync.prototype._stat=function(t){var r=this._makeAbs(t),s="/"===t.slice(-1);if(t.length>this.maxLength)return!1;if(!this.stat&&ownProp(this.cache,r)){var i=this.cache[r];if(Array.isArray(i)&&(i="DIR"),!s||"DIR"===i)return i;if(s&&"FILE"===i)return!1}var e=this.statCache[r];if(!e){var o;try{o=fs.lstatSync(r)}catch(t){return!1}if(o.isSymbolicLink())try{e=fs.statSync(r)}catch(t){e=o}else e=o}this.statCache[r]=e;i=e.isDirectory()?"DIR":"FILE";return this.cache[r]=this.cache[r]||i,(!s||"DIR"===i)&&i},GlobSync.prototype._mark=function(t){return common.mark(this,t)},GlobSync.prototype._makeAbs=function(t){return common.makeAbs(this,t)};