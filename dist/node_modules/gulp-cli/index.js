"use strict";var fs=require("fs"),path=require("path"),log=require("gulplog"),yargs=require("yargs"),Liftoff=require("liftoff"),interpret=require("interpret"),v8flags=require("v8flags"),findRange=require("semver-greatest-satisfied-range"),ansi=require("./lib/shared/ansi"),exit=require("./lib/shared/exit"),tildify=require("./lib/shared/tildify"),makeTitle=require("./lib/shared/make-title"),cliOptions=require("./lib/shared/cli-options"),completion=require("./lib/shared/completion"),verifyDeps=require("./lib/shared/verify-dependencies"),cliVersion=require("./package.json").version,getBlacklist=require("./lib/shared/get-blacklist"),toConsole=require("./lib/shared/log/to-console"),loadConfigFiles=require("./lib/shared/config/load-files"),mergeConfigToCliFlags=require("./lib/shared/config/cli-flags"),mergeConfigToEnvFlags=require("./lib/shared/config/env-flags"),logVerify=require("./lib/shared/log/verify"),logBlacklistError=require("./lib/shared/log/blacklist-error"),ranges=fs.readdirSync(__dirname+"/lib/versioned/");process.env.INIT_CWD=process.cwd();var cli=new Liftoff({name:"gulp",processTitle:makeTitle("gulp",process.argv.slice(2)),completions:completion,extensions:interpret.jsVariants,v8flags:v8flags,configFiles:{".gulp":{home:{path:"~",extensions:interpret.extensions},cwd:{path:".",extensions:interpret.extensions}}}}),usage="\n"+ansi.bold("Usage:")+" gulp "+ansi.blue("[options]")+" tasks",parser=yargs.usage(usage,cliOptions),opts=parser.argv;function run(){cli.launch({cwd:opts.cwd,configPath:opts.gulpfile,require:opts.require,completion:opts.completion},handleArguments)}function handleArguments(e){var i=loadConfigFiles(e.configFiles[".gulp"],["home","cwd"]);if(opts=mergeConfigToCliFlags(opts,i),e=mergeConfigToEnvFlags(e,i),opts.continue&&(process.env.UNDERTAKER_SETTLE="true"),toConsole(log,opts),opts.help&&(parser.showHelp(console.log),exit(0)),opts.version&&(log.info("CLI version",cliVersion),e.modulePackage&&void 0!==e.modulePackage.version&&log.info("Local version",e.modulePackage.version),exit(0)),opts.verify){var r=!0!==opts.verify?opts.verify:"package.json";return path.resolve(r)!==path.normalize(r)&&(r=path.join(e.cwd,r)),log.info("Verifying plugins in "+r),getBlacklist(function(e,i){if(e)return logBlacklistError(e);var o=verifyDeps(require(r),i);logVerify(o)})}e.modulePath||(log.error(ansi.red("Local gulp not found in"),ansi.magenta(tildify(e.cwd))),log.error(ansi.red("Try running: npm install gulp")),exit(1)),e.configPath||(log.error(ansi.red("No gulpfile found")),exit(1)),process.cwd()!==e.cwd&&(process.chdir(e.cwd),log.info("Working directory changed to",ansi.magenta(tildify(e.cwd))));var o=findRange(e.modulePackage.version,ranges);if(!o)return log.error(ansi.red("Unsupported gulp version",e.modulePackage.version));require(path.join(__dirname,"/lib/versioned/",o,"/"))(opts,e,i)}toConsole(log,opts),cli.on("require",function(e){log.info("Requiring external module",ansi.magenta(e))}),cli.on("requireFail",function(e){log.error(ansi.red("Failed to load external module"),ansi.magenta(e))}),cli.on("respawn",function(e,i){var r=ansi.magenta(e.join(", ")),o=ansi.magenta(i.pid);log.info("Node flags detected:",r),log.info("Respawned to PID:",o)}),module.exports=run;